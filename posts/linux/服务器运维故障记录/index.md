# æœåŠ¡å™¨è¿ç»´æ•…éšœè®°å½•


# Mysql  Errcode: 24 - Too many open files 
&gt; [https://blog.csdn.net/weixin_36343850/article/details/86293700](https://blog.csdn.net/weixin_36343850/article/details/86293700)   

åŽŸå› ï¼šæ‰“å¼€æ–‡ä»¶æ•°é‡å¤ªå¤šï¼Œè¶…å‡ºäº†`open_files_limit`è¿™ä¸ªå‚æ•°çš„é™åˆ¶ï¼Œåœ¨ä¸€ä¸ªè¡¨ä¸­æœ‰å¤šä¸ªåˆ†åŒºçš„æ—¶å€™ï¼Œè¿™ç§æƒ…å†µæ›´å®¹æ˜“å‘ç”Ÿã€‚  
è§£å†³æ–¹æ³•ï¼š 
- æŸ¥çœ‹ `open_files_limit`å‚æ•°, ä½¿ç”¨`show variables like &#39;%open%&#39;;`å°±å¯ä»¥çœ‹åˆ°äº†   
- ä¿®æ”¹ `open_files_limit`å‚æ•°  
 åœ¨ç½‘ä¸Šæ‰¾äº†å¾ˆå¤šèµ„æ–™ï¼Œæœ‰çš„è¯´ç›´æŽ¥åœ¨`/etc/mysql/mysql.conf.d/mysqld.cnf`æ–‡ä»¶ä¸­çš„`[mysqld]`éƒ¨åˆ†æ·»åŠ `open_files_limit`å‚æ•°ï¼Œæ¯”å¦‚`open_files_limit=10240`ï¼Œå¹¶ä¸”åœ¨`/etc/security/limits.conf` æ·»åŠ `mysql soft nofile 10240`å’Œ`mysql hard nofile 10240`è¿™ä¸¤ä¸ªå‚æ•°ç„¶åŽé‡å¯`MySQL`ï¼Œä½†æ˜¯å‘çŽ°ä¸èƒ½ç”Ÿæ•ˆã€‚  
- ä»¥ä¸‹æ–¹æ³•å¯ç”¨ï¼š 
  - åœ¨æ–‡ä»¶`/etc/systemd/system/multi-user.target.wants/mysql.service`(ä¹Ÿæœ‰å¯èƒ½æ˜¯`/etc/systemd/system/mysql.service`è¿™ä¸ªæ–‡ä»¶)æœ€åŽæ·»åŠ `LimitNOFILE=10240`  
- ç„¶åŽæ‰§è¡Œ`systemctl daemon-reload`ï¼ŒæŽ¥ç€å†é‡å¯`mysql`æœåŠ¡`sudo service mysql restart`,å¯ä»¥çœ‹åˆ°å·²ç»ä¿®æ”¹æˆåŠŸäº†  

# ç¦…é“bugç®¡ç†ç³»ç»Ÿ 
1. è¿™ä¸ªéƒ¨ç½²é‡åˆ°çš„ä¸€ä¸ªå‘å°±æ˜¯`php`æ‰“æ­»èŽ·å–ä¸åˆ°`session`çš„ä½ç½®  
æ‰“å¼€è°ƒè¯•æ—¥å¿—æ–¹å¼æ˜¯å°†`my.cnf` ä¸­`debug`è®¾ç½®ä¸º`true`  
å®žé™…é”™è¯¯ä½“çŽ°æ˜¯ `ERROR: æ‚¨è®¿é—®çš„åŸŸå xxx.xxx.xxx æ²¡æœ‰å¯¹åº”çš„å…¬å¸ã€‚`  
æˆ‘çš„è§£å†³æ–¹æ¡ˆæ˜¯ ä»£ç ç›®å½•æ•´ä½“æƒé™è®¾ç½®ä¸º`777`,ç„¶åŽåˆ é™¤æŽ‰`my.cnf`è¿›è¡Œé‡è£…,é‡è£…åŽåœ¨ç›®å½•æƒé™è°ƒæ•´ä¸ºæ­£å¸¸æƒé™å³å¯.  
3. å®‰è£…å®ŒæˆåŽï¼Œé¦–é¡µå‡ºçŽ°æ— é™å¾ªçŽ¯é‡å®šå‘ï¼Œæ‰‹åŠ¨å°†`my.php`ä¸­`PATH_INFO`ä¿®æ”¹ä¸º`GET`ï¼Œæˆ–åœ¨`nginx`ä¼ å…¥å˜é‡`PATH_INFO`å€¼`$request_uri;`

# nginx ä»£ç†phpäº§ç”Ÿçš„ä¸€äº›æ•…éšœ
è®°å½•ä¸€ä¸ª`nginx` ä»£ç† `php` äº§ç”Ÿçš„é—®é¢˜,é—®é¢˜å·²ç»è§£å†³äº†,ä½†æ˜¯ä¼¼ä¹Žè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°æ ¹æœ¬åŽŸå› ,**è‹¥æœ‰äº†è§£çš„,è¯·ä¸€å®šè§£æƒ‘ä¸€äºŒ**, ä»¥ä¸‹è®°å½•ä¸‹å¤„ç†è¿‡ç¨‹ . 
- é—®é¢˜äº§ç”Ÿè¿‡ç¨‹:  
  - AæœåŠ¡å™¨ä»£ç è¿ç§»åˆ°Bæœºå™¨ä¸Š,ä»£ç æ˜¯`rsync`ç›´æŽ¥åŒæ­¥çš„,ç„¶åŽBè¿è¡Œçš„æ—¶å€™å°±å‡ºé—®é¢˜äº†,æ ¹æ®è°ƒè¯•å‘çŽ°,æ— è®ºè®¿é—®ä»€ä¹ˆ(html/js/css)éƒ½ä¼šè·³è½¬åˆ°é¦–é¡µ,å®žé™…åº”è¯¥æ˜¯éƒ½ä¼šç»è¿‡`php`è§£æž(æˆ‘å‘èª“Aå’ŒBçš„çŽ¯å¢ƒé…ç½®æ˜¯ä¸€æ¨¡ä¸€æ ·çš„!Aå¯ä»¥æ­£å¸¸è¿è¡Œ.), `php`æ¡†æž¶ä¸º`opencart` .   

- æµè§ˆå™¨è®¿é—®è¡¨çŽ°ä»¥ä¸‹é”™è¯¯:   
  - `Resource interpreted as Stylesheet but transferred with MIME type text/html` 
  - `ERR_CONNECTION_REFUSED`  

- å¤„ç†è¿‡ç¨‹ :
  - é—®é¢˜å®žé™…ä¸Šæ˜¯å¤´ä¸€å¤©å‘ç”Ÿçš„,ç»è¿‡å¤šæ–¹è°ƒè¯•å‘çŽ°,å®žé™…ä¸Šé€šè¿‡åŸŸåè®¿é—®ä»»ä½•èµ„æºå‡ä¼šè·³è½¬åˆ°é¦–é¡µ,è®¿é—®`php`èµ„æºåˆ™ä¼šå‡ºçŽ°æ— æ³•åŠ è½½`js/css`ç­‰é™æ€èµ„æºå…¨éƒ¨éƒ½æ˜¯`MIME`ç±»åž‹é—®é¢˜,`nginx`å¼ºè¡Œç»™`css/js`ç­‰èµ„æºè®¾ç½®ä¸€ä¸ª`content-type`å‰ç«¯ä¹Ÿæ— æ³•è¯†åˆ«æ­£ç¡®,å¦å¤–ä¹Ÿæµ‹è¯•è¿‡ç½‘ä¸Šæä¾›çš„å¤šæ–¹è§£å†³æ–¹æ¡ˆ,ä»ç„¶æ— æ³•å¾—åˆ°è§£å†³ .  
  - ç¬¬äºŒå¤©, ä¿æŒåŽŸæœ‰`nginx`é…ç½® , æˆ‘ç»™å¯¹åº”ç«™ç‚¹é¦–é¡µçš„`index.php`ä»£ç ä¸­åŠ å…¥äº†`echo 123; exit();`è¿›è¡Œæµ‹è¯•,è®¿é—®å‘çŽ°å¯æ­£å¸¸æ–­å¼€,æ­¤æ—¶åœ¨è®¿é—®æ ¹ä¸‹çš„é™æ€`html`æµ‹è¯•æ–‡ä»¶,å‘çŽ°å¯ä»¥æ­£å¸¸è®¿é—®äº†,æ­¤æ—¶åˆ é™¤`echo 123; exit();`,é‡æ–°è®¿é—®`index.php`,å‘çŽ°(js/css)é™æ€èµ„æºè¢«å‡çº§ä¸º`https`è®¿é—®,æ­¤æ—¶æˆ‘ç»™ç›¸å…³åŸŸåé…ç½®ä¸Šè¯ä¹¦,ç„¶åŽè®¿é—®å°±æ­£å¸¸äº†!!!  

- åŽŸå› åˆ†æž:     
  - ç«™ç‚¹ç¼“å­˜(è¿™ä¸ªå¯èƒ½æ€§æœ€å¤§),`opencart`æ¡†æž¶å®žé™…ä¸Š`session`æ˜¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­çš„,ä¼°è®¡å¾ˆå¤šçš„`cache`ä¹Ÿæ˜¯å­˜äºŽæ•°æ®ä¸­çš„,è€Œä»Šå¤©è§£å†³çš„æ—¶é—´ä¹Ÿæ°å¥½è·ç¦»æˆ‘æœ€åŽä¸€æ¬¡åŒæ­¥ä¸€å¤©çš„æ ·å­.  
  - `nginx` é…ç½®åŸŸåè¿‡å¤š,å¯¼è‡´é…ç½®æ··ä¹±. BæœåŠ¡å™¨çš„`nginx`å®žé™…ä¸Šå·²ç»é…ç½®äº†å¾ˆå¤šä¸ªåŸŸå,`php`è§£æžçš„`SCRIPT_FILENAME` æˆ‘ä½¿ç”¨çš„æ˜¯`$document_root`,æœ€åŽä¸€æ¬¡ä¿®æ”¹æˆ‘ä¹Ÿå°†`$document_root`ä¿®æ”¹ä¸ºäº†å…·ä½“çš„è·¯å¾„,ä¸çŸ¥é“ä¼šä¸ä¼šæ˜¯è¿™ä¸ªåŽŸå› äº§ç”Ÿçš„.  


# zabbix è‡ªåŠ¨å‘çŽ°å¼‚å¸¸é”™è¯¯  
-  å…·ä½“é”™è¯¯è¡¨çŽ°  
1. `Cannot create item: item with the same key &#34;domain.status[{#DOMAIN_NAME},http_code]&#34; already exists.`  
2. `Cannot accurately apply filter: no value received for macro &#34;{#DOMAINNAME}&#34;.`  
- è§£å†³æ–¹æ¡ˆ  
  - è¿™ä¸ªæ˜¯ç‰¹ä¹ˆçš„è‡ªåŠ¨å‘çŽ°è„šæœ¬è¿”å›žå€¼çš„`key`å¿…é¡»ç”¨`{}`æ‹¬èµ·æ¥,ä¸ç„¶ä½ å³ä½¿æ˜¯`json`æ ¼å¼ä»–ä¹Ÿä¸ä¼šè®¤, ç½‘ä¸Šé‚£äº›è¿™ä¸ªæŠ„é‚£ä¸ªçš„å‘è´§å°±åªçŸ¥é“å˜é‡è¦å¤§å†™ï¼Œè¿˜æœ‰ä¸ªå‘å‘Šè¯‰æˆ‘è¦ä½¿ç”¨å®,ç”¨äº†å®å°±æ˜¯ç¬¬äºŒä¸ªé—®é¢˜,ä¸ç”¨ç¬¬ä¸€ä¸ªï¼Œè¿™æˆ‘æ˜¯è®°å¾—å¾ˆæ¸…æ¥šï¼Œå®å¹¶ä¸æ˜¯å¿…å®šè¦æœ‰çš„å•Šï¼Œæˆ‘ä»¥å‰å†™ä¹ŸåŸºæœ¬æ²¡æœ‰åŠ è¿‡ã€‚ æˆ‘ç‰¹ä¹ˆä¹Ÿæ˜¯è ¢äº†ï¼Œå†™äº†è¿™ä¹ˆå¤šçš„è‡ªåŠ¨å‘çŽ°ï¼Œå±…ç„¶æ²¡æœ‰æ³¨æ„è¦æ‹¬èµ·æ¥ã€‚ 

# nginx ä¼ªé™æ€æ— æ•ˆé—®é¢˜ 
- å…·ä½“é”™è¯¯ä½“çŽ°
æ‹¿åˆ°`apache`çš„`.htaccess`æ–‡ä»¶åŽï¼Œé€šè¿‡[`https://www.winginx.com/en/htaccess`](https://www.winginx.com/en/htaccess)è½¬æ¢ä¸ºäº†`nginx`å¯ç”¨çš„è§„åˆ™ï¼Œä½†åŠ å…¥åŽè®¿é—®è·³è½¬ä¸€ç›´æ˜¯`404`,ç»æ£€æŸ¥`location`æ˜¯å®šä½æˆåŠŸäº†çš„ï¼Œä½†å°±æ˜¯è®¿é—®ä¸äº†
- è§£å†³æ–¹æ¡ˆ: 
 1. åŽç»­å¼€å‘æä¾›äº†å¦ä¸€ä¸ªä¼ªé™æ€é…ç½®,æ‰€æœ‰`rewrite`æ˜¯æ”¾åœ¨`if`æŒ‡ä»¤ä¸­(`!-e $request_filename`)ï¼Œç„¶åŽå°±å¯ä»¥äº†ã€‚æˆ‘å¯¹æ¯”äº†ä¸‹ï¼Œä¸¤è€…çš„å·®å¼‚å°±æ˜¯ï¼Œä¸€ä¸ªæ˜¯æ”¾åœ¨äº†`location`ä¸­ï¼Œå®šä½äº†æ¯ä¸€ä¸ª`rewrite`æ‰€åœ¨çš„ä½ç½®ã€‚è¿˜æœ‰å°±æ˜¯æ”¾åœ¨`if`ä¸­çš„`rewrite`çš„åŒ¹é…è§„åˆ™æ˜¯ç”¨å¼•å·æ‹¬èµ·æ¥äº†çš„ã€‚å…·ä½“åŽŸå› æš‚æ—¶è¿˜æ˜¯æ¯æžæ¸…æ¥šã€‚åŽç»­å‡ºçŽ°éœ€æµ‹è¯•ä¸‹å¼•å·æ˜¯å¦æœ‰å½±å“.

# nginx åå‘ä»£ç†åŽç«¯æœåŠ¡å™¨ï¼Œéƒ¨åˆ†èµ„æºå‡ºçŽ°502é”™è¯¯ 
é—®é¢˜æè¿°: åŽç«¯æ˜¯`dotnet`åº”ç”¨ï¼Œåå‘ä»£ç†æ—¶å€™åŸŸåè¯·æ±‚é¡µé¢éƒ¨åˆ†`css`/`js`èµ„æºè¿”å›ž`502`é”™è¯¯ã€‚ç›´æŽ¥è¯·æ±‚æŠ¥é”™çš„`css`/`js`åˆæ˜¯æ­£å¸¸çš„ï¼Œå‰ç«¯ç»•è¿‡`nginx`ç›´æŽ¥è®¿é—®`dotnet`æ‰€æœ‰è¿”å›žåˆæ˜¯æ­£å¸¸çš„ã€‚åªæœ‰ç»è¿‡`nginx`ä¼šå‡ºçŽ°è¯¥é—®é¢˜ã€‚
è§£å†³è¿‡ç¨‹ï¼š
  - ç½‘ä¸Šæœç´¢åˆ°å¾ˆå¤šçš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ä¸€ä¸ªæ„Ÿè§‰æœ‰ç‚¹ç”¨ï¼Œä½†***å¹¶æ²¡æœ‰è§£å†³æˆ‘çš„é—®é¢˜***,è¯´çš„æ˜¯`headerè¿‡å¤§ï¼Œè¶…å‡ºäº†é»˜è®¤çš„1kï¼Œå°±ä¼šå¼•å‘ä¸Šè¿°çš„upstream sent too big headerï¼ŒnginxæŠŠå¤–éƒ¨è¯·æ±‚ç»™åŽç«¯å¤„ç†ï¼ŒåŽç«¯è¿”å›žçš„headerå¤ªå¤§ï¼Œnginxå¤„ç†ä¸è¿‡æ¥å°±ä¼šå¯¼è‡´502`ï¼Œè¿™ä¸ªé—®é¢˜æå‡ºçš„è§£å†³æ˜¯ï¼Œå¢žå¤§`proxy_buffer_size`/`proxy_buffers`/`proxy_busy_buffers_size`,ä¸è¿‡è¿˜æ˜¯è®°å½•ä¸‹ï¼Œæ¯•ç«Ÿä¸æ˜¯æ¯ä¸ªé—®é¢˜åŽŸå› éƒ½ä¸€æ ·ã€‚
  - è¿™æ˜¯æˆ‘å½“æ—¶å‚è€ƒçš„ç¬¬äºŒä¸ªæ–¹æ¡ˆ,æ ¹æ®å®˜æ–¹æ–‡æ¡£[`https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive`](https://nginx.org/en/docs/http/ngx_http_upstream_module.html#keepalive),è°ƒæ•´äº†`upstream`ä¸­`keepalive`,æˆ‘åŽŸæ¥è®¾ç½®çš„æ˜¯`2`,çŽ°è°ƒæ•´ä¸º`16`,å¹¶è®¾ç½®äº†`Connection &#34;Keep-Alive&#34;;`(è¿™ä¸ªè®¾ç½®æ˜¯ä¸ºäº†ä¿æŒ`http/1.0`æŒä¹…é“¾æŽ¥ï¼Œå®˜æ–¹ä¸å»ºè®®ä½¿ç”¨æ­¤å‚æ•°ï¼Œä½†æˆ‘è¿™è¾¹`websokcet`å’Œ`http/1.0`,å•ç‹¬è®¾ç½®ä¸€ä¸ªå¹¶æ²¡æœ‰æ•ˆæžœï¼Œæ‰€ä»¥ä¸¤ä¸ªéƒ½è®¾ç½®äº†)ã€‚è¿™ä¸ªæ–¹æ¡ˆå½“æ—¶è§£å†³äº†ä¸€éƒ¨åˆ†çš„é—®é¢˜ã€‚ä½†æ ¹æœ¬å¹¶æœªå¾—åˆ°è§£å†³ã€‚
  - ç„¶åŽæœ€ç»ˆçš„æ–¹æ¡ˆï¼Œé‡å¯åº”ç”¨æœåŠ¡å™¨ï¼Œé—®é¢˜å®Œå…¨è§£å†³ï¼ï¼ï¼

åŽŸå› åˆ†æžï¼šçªç„¶ä¸çŸ¥é“æ€Žä¹ˆä¸‹ç¬”äº†ï¼Œåæ­£å°±æ˜¯ç³»ç»Ÿtcpè¿žæŽ¥è¿‡å¤šï¼Œæœ€å¼€å§‹ä½“çŽ°å°±æ˜¯å‡ºçŽ°å¤§é‡çš„`CLOSE_WAIT`,å½“æ—¶é‡å¯äº†å¯¹åº”å ç”¨çš„ç¨‹åºï¼Œæ¸…ç†ä¸€äº›è¿žæŽ¥ï¼Œå‡ºçŽ°ä¸€å®šçš„å¥½è½¬ï¼Œä½†ä¹Ÿä»…ä»…å‡ºçŽ°äº†å¥½è½¬ï¼ŒåŽé¢å¯èƒ½ç”±äºŽæŸäº›åŽŸå› ï¼Œå¯¼è‡´é‡å¯åº”ç”¨ä¹Ÿæ— æ³•è§£å†³äº†ï¼Œæœ€åŽé‡å¯æœåŠ¡å™¨ï¼Œé—®é¢˜å®Œå…¨è§£å†³ã€‚ åº”è¯¥ä¸æ˜¯æ¯ä¸ªäººéƒ½æ˜¯è¿™ä¸ªåŽŸå› ï¼Œä¸è¿‡å¯ä»¥å‚è€ƒä¸‹ã€‚

# nginx åå‘ä»£ç† cdnå›žæº(å¤šå±‚nginx)å‡ºçŽ° 502ã€503ã€504 ç­‰å¼‚å¸¸ 
åœ¨æˆ‘çš„éƒ¨ç½²æ¨¡å¼ä¸­ï¼Œå¾ˆå¤šæ—¶å€™éƒ½æ˜¯`docker`ä¸Žå®žé™…åº”ç”¨çŽ¯å¢ƒæ··åˆéƒ¨ç½²(å¤šçŽ¯å¢ƒï¼Œå•èŠ‚ç‚¹)ï¼Œå¤§å¤šçš„ç»“æž„æ˜¯ `docker`è¿è¡Œç¨‹åºçŽ¯å¢ƒï¼Œ`nginx`åå‘ä»£ç†åˆ°`docker`æš´éœ²çš„ç«¯å£ï¼Œä»Žè€Œå®žçŽ°åº”ç”¨çš„æ­£å¸¸è®¿é—®ã€‚æˆ‘è¿™æ¬¡é‡åˆ°çš„è¿™ä¸ªé—®é¢˜ï¼Œæœ€å¼€å§‹çš„æ—¶å€™æˆ‘ä»¥ä¸ºæ˜¯`cdn`çš„é—®é¢˜ï¼Œå› ä¸ºå½“æ—¶æˆ‘æ²¡æœ‰é€šè¿‡`cdn`ç›´è¾¾æœåŠ¡å™¨çš„æ—¶å€™è®¿é—®éƒ½æ˜¯æ­£å¸¸çš„ï¼Œç„¶åŽé€šè¿‡`cdn`åŽï¼Œé¡µé¢å¤§å¤šæ•°è¯·æ±‚å°±éƒ½å‡ºçŽ°äº†`502`ç­‰çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘è”ç³»äº†è¿è¥å•†ï¼Œä»–ä»¬è¯´å›žæºé“¾æŽ¥è¢«æ–­å¼€äº†ï¼Œæ˜¯ä¸æ˜¯æœåŠ¡å™¨ä¸Šæœ‰ç›¸å…³å®‰å…¨ç­–ç•¥ï¼Œä»”ç»†çš„æƒ³äº†ä¸‹ï¼ŒæœåŠ¡å™¨ä¸Šé™¤äº†å¼€å¯äº†`iptables`å¤–ï¼Œå¹¶æ²¡æœ‰å…¶ä»–çš„å®‰å…¨è®¾ç½®ï¼Œæ­£æ²¡æœ‰å¤´ç»ªçš„æ—¶å€™ï¼Œçªç„¶æƒ³åˆ°`docker`éœ€è¦ä¾èµ–`iptables`è½¬å‘ï¼Œæ˜¯ä¸æ˜¯è¿™ä¸ªåŽŸå› å¯¼è‡´é˜²ç«å¢™åˆæœ‰é—®é¢˜äº†(å› ä¸ºä¹‹å‰æˆ‘è°ƒæ•´iptablesçš„æ—¶å€™ï¼Œå¯¼è‡´è¿‡dockerå®¹å™¨æ— æ³•è¿žæŽ¥ç½‘ç»œðŸ˜¥)ï¼ŒäºŽæ˜¯æˆ‘æŠŠé˜²ç«å¢™ä¸€å…³ï¼Œç„¶åŽ`cdn`å›žæºå°±æ­£å¸¸äº†ã€‚ åŽç»­çš„å¤„ç†ï¼Œæˆ‘å…³é—­äº†æœåŠ¡å™¨é˜²ç«å¢™è®¾ç½®ï¼Œé‡å¯äº†`docker`ï¼Œé‡å»ºäº†å®¹å™¨(é˜²æ­¢å®¹å™¨ç½‘ç»œå‡ºçŽ°é—®é¢˜ï¼ŒåŒæ—¶è®©`docker`é‡æ–°åˆ›å»ºè‡ªå·±çš„è§„åˆ™é“¾)ã€‚å¯¹å¤–çš„é˜²ç«å¢™é‡‡ç”¨äº‘é˜²ç«å¢™çŽ°åœ¨å…¬ç½‘æµå…¥æµé‡ã€‚ä¸Šé¢å…¶ä»–è®°å½•çš„æ•…éšœä¸­ï¼Œä¼°è®¡ä¹Ÿæœ‰è¿™ä¸ªåŽŸå› å¯¼è‡´çš„ï¼Œä½†æ˜¯ä¸çŸ¥é“æ€Žä¹ˆè°ƒå¥½äº†ã€‚(TODO:// ä¸€ä¸ªäººè¿ç»´å¥½éš¾ï¼Œæœ‰ç‚¹å•¥é—®é¢˜éƒ½ä¸çŸ¥é“è¯¥æ‰¾è°è®¨è®ºä¸‹ï¼Œå…¨é è‡ªå·±æ‘¸ç´¢)

# nginx: [emerg] location &#34;&lt;xxxxxxxx&gt;&#34; cannot be inside the exact location &#34;/favicon.ico&#34; in xxxxxx
æˆ‘è¿™è¾¹é‡åˆ°çš„æ­¤ç±»é—®é¢˜å¤šæ•°ä¸ºåœ¨`location =/xxx {`ä¸‹ç»§ç»­`include`äº†`location` ,æ¸…é™¤åŽè§£å†³


# IISä½Žç‰ˆæœ¬æœªæ˜ å°„ WebResource.axd æ–‡ä»¶ï¼Œå¯¼è‡´ç›¸å…³å›¾ç‰‡æˆ–jsç­‰æ— æ³•æ­£å¸¸åŠ è½½ (å¤šå‡ºçŽ°åœ°ç‰ˆæœ¬æœåŠ¡å™¨ä¸Š,å½“å‰è®°å½•server 2008 r2)
- å¤„ç†: 
é…ç½®ç¼–è¾‘å™¨ --&gt; `system.web/httpHandlers/` --&gt; ç‚¹å‡» `Count` å³ä¾§çš„å°ç‚¹å±•å¼€, ç„¶åŽæ·»åŠ `Path:WebResource.axd`ã€`type: System.Web.Handlers.AssemblyResourceLoader`,  `validate: True` , `verb: GET` ï¼Œå®ŒæˆåŽå…³é—­   
```xml
&lt;configuration&gt;
   &lt;system.web&gt;
       &lt;httpHandlers&gt;
           &lt;add path=&#34;WebResource.axd&#34; verb=&#34;GET&#34; type=&#34;System.Web.Handlers.AssemblyResourceLoader&#34; validate=&#34;True&#34; /&gt;
       &lt;tpHandlers&gt;
   &lt;/system.web&gt;
&lt;/configuration&gt;
```

# IIS å¦‚ä½•ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ é™åˆ¶
è¦ä¿®æ”¹IISä¸­çš„æ–‡ä»¶ä¸Šä¼ é™åˆ¶ï¼Œå¯ä»¥æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š
1. æ‰“å¼€IISç®¡ç†å™¨ï¼ˆ`Internet Information Services Manager`ï¼‰ã€‚
2. åœ¨å·¦ä¾§å¯¼èˆªæ ä¸­ï¼Œå±•å¼€æœåŠ¡å™¨èŠ‚ç‚¹ï¼Œå¹¶æ‰¾åˆ°æ‚¨è¦ä¿®æ”¹çš„ç«™ç‚¹ã€‚å•å‡»è¯¥ç«™ç‚¹ã€‚
3. åœ¨å³ä¾§çª—å£ä¸­ï¼ŒåŒå‡»â€œé…ç½®ç¼–è¾‘å™¨â€å›¾æ ‡ã€‚
4. åœ¨â€œé…ç½®ç¼–è¾‘å™¨â€çª—å£ä¸­ï¼Œé€‰æ‹©â€œ`system.webServer/Security/requestFiltering`â€èŠ‚ç‚¹ã€‚
5. åœ¨å³ä¾§çª—å£ä¸­ï¼ŒæŸ¥æ‰¾å¹¶ç¼–è¾‘ä»¥ä¸‹è®¾ç½®æ¥ä¿®æ”¹æ–‡ä»¶ä¸Šä¼ é™åˆ¶ï¼š
   - `maxAllowedContentLength`ï¼šæ­¤è®¾ç½®ç”¨äºŽé™åˆ¶è¯·æ±‚å†…å®¹çš„æœ€å¤§å¤§å°ã€‚ä»¥å­—èŠ‚ä¸ºå•ä½ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœè¦å°†ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶ä¸º100MBï¼Œåˆ™å°†å…¶è®¾ç½®ä¸º104857600ï¼ˆ100MB * 1024KB * 1024Bï¼‰ã€‚
   - `maxRequestLength`ï¼šæ­¤è®¾ç½®ç”¨äºŽé™åˆ¶è¯·æ±‚çš„æœ€å¤§å¤§å°ã€‚ä»¥KBä¸ºå•ä½ã€‚ä¾‹å¦‚ï¼Œå¦‚æžœè¦å°†ä¸Šä¼ æ–‡ä»¶å¤§å°é™åˆ¶ä¸º100MBï¼Œåˆ™å°†å…¶è®¾ç½®ä¸º102400ï¼ˆ100MB * 1024KBï¼‰ã€‚

   æ³¨æ„ï¼šè¿™ä¸¤ä¸ªè®¾ç½®éœ€è¦åŒæ—¶æ›´æ”¹ï¼Œä»¥ç¡®ä¿æ–‡ä»¶ä¸Šä¼ é™åˆ¶çš„ç”Ÿæ•ˆã€‚

6. ä¿®æ”¹å®Œä¸Šè¿°è®¾ç½®åŽï¼Œç‚¹å‡»â€œåº”ç”¨â€æŒ‰é’®ä¿å­˜æ›´æ”¹ã€‚
7. å…³é—­â€œé…ç½®ç¼–è¾‘å™¨â€çª—å£å’ŒIISç®¡ç†å™¨ã€‚

çŽ°åœ¨ï¼Œæ‚¨å·²æˆåŠŸä¿®æ”¹äº†IISä¸­çš„æ–‡ä»¶ä¸Šä¼ é™åˆ¶ã€‚è¯·æ³¨æ„ï¼Œè¿™äº›è®¾ç½®å¯èƒ½ä¼šå¯¹æ•´ä¸ªç«™ç‚¹æˆ–è™šæ‹Ÿç›®å½•äº§ç”Ÿå½±å“ï¼Œå› æ­¤è¯·ç¡®ä¿æ ¹æ®éœ€è¦è¿›è¡Œé€‚å½“çš„è°ƒæ•´ã€‚
```xml
&lt;configuration&gt;
    &lt;system.webServer&gt;
        &lt;security&gt;
            &lt;requestFiltering&gt;
                &lt;!-- 100M --&gt;
                &lt;requestLimits maxAllowedContentLength=&#34;100000000&#34; /&gt; 
            &lt;/requestFiltering&gt;
        &lt;/security&gt;
    &lt;/system.webServer&gt;
&lt;/configuration&gt;
```

# IIS .net é¡¹ç›® post æ— æ³•æäº¤æ•°æ®
- .net ç«™ç‚¹ curl postè¯·æ±‚ï¼Œæ¨¡æ‹Ÿè¡¨å•æäº¤ï¼ŒåŽç«¯æ”¶ä¸åˆ°æ•°æ®ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯æŠŠç¨‹åºæ± çš„é›†æˆæ¨¡å¼æ”¹ä¸ºç»å…¸æ¨¡å¼ 

# IIS .net é¡¹ç›® ï¼ŒåŒé¡¹ç›®å¤åˆ¶ä¸€ä»½å‡ºæ¥é‡æ–°éƒ¨ç½²å°±æ— æ³•æ­£å¸¸ä½¿ç”¨äº† 
å¤§è‡´é—®é¢˜ä½“çŽ°æ˜¯ `[Exception: æœªå°†å¯¹è±¡å¼•ç”¨è®¾ç½®åˆ°å¯¹è±¡çš„å®žä¾‹ã€‚] FrontEndProcessor.VoiceUtils.TextToSpeech xxxx`  
äº§ç”ŸåŽŸå› : åŒä¸€æœåŠ¡å™¨ä¸Šé¢ï¼Œç›´æŽ¥å¤åˆ¶äº†ä¸€ä»½å‡ºæ¥ï¼Œè¢«å¤åˆ¶çš„ç«™ç‚¹æ˜¯å¯ä»¥æ­£å¸¸ä½¿ç”¨çš„ï¼Œå¤åˆ¶å‡ºæ¥åŽçš„ç«™ç‚¹ï¼Œç›¸å¯¹äºŽå¤åˆ¶å‰çš„ç«™ç‚¹åŒä¸€åŠŸèƒ½å°±æ— æ³•æ­£å¸¸ä½¿ç”¨äº†ã€‚
è§£å†³ï¼š ç»å¤šæ–¹å¯¹æ¯”ï¼Œå‘çŽ°é—®é¢˜æ˜¯ç”±äºŽç¨‹åºæ± è®¾ç½®å¯¼è‡´ï¼Œå¤åˆ¶åŽçš„ç«™ç‚¹ï¼Œç¨‹åºæ± æœªå¼€å¯ `åŠ è½½ç”¨æˆ·é…ç½®æ–‡ä»¶`ã€‚
æ€»ç»“ï¼š `windows`ä¸Šåº”ä¸ä¼šå­˜åœ¨æƒé™ç›¸å…³é—®é¢˜ï¼Œå› æ­¤æ­¤ç±»é—®é¢˜åº”è¯¥ä¼˜å…ˆè€ƒè™‘ç¨‹åºæ± 



# IIS .neté¡¹ç›®ä¸‹è½½æ–‡ä»¶å‡ºçŽ°è®¿é—®è¢«æ‹’ç»
- å¼‚å¸¸ä½“çŽ°
```
  å¯¹è·¯å¾„â€œxxxx.JPGâ€çš„è®¿é—®è¢«æ‹’ç»ã€‚
  è¯´æ˜Ž: æ‰§è¡Œå½“å‰ Web è¯·æ±‚æœŸé—´ï¼Œå‡ºçŽ°æœªç»å¤„ç†çš„å¼‚å¸¸ã€‚è¯·æ£€æŸ¥å †æ ˆè·Ÿè¸ªä¿¡æ¯ï¼Œä»¥äº†è§£æœ‰å…³è¯¥é”™è¯¯ä»¥åŠä»£ç ä¸­å¯¼è‡´é”™è¯¯çš„å‡ºå¤„çš„è¯¦ç»†ä¿¡æ¯ã€‚

  å¼‚å¸¸è¯¦ç»†ä¿¡æ¯: System.UnauthorizedAccessException: å¯¹è·¯å¾„â€œxxxx.JPGâ€çš„è®¿é—®è¢«æ‹’ç»ã€‚

  ASP.NET æ— æƒè®¿é—®æ‰€è¯·æ±‚çš„èµ„æºã€‚è¯·è€ƒè™‘å¯¹ ASP.NET è¯·æ±‚æ ‡è¯†æŽˆäºˆè®¿é—®æ­¤èµ„æºçš„æƒé™ã€‚ASP.NET æœ‰ä¸€ä¸ªåœ¨åº”ç”¨ç¨‹åºæ²¡æœ‰æ¨¡æ‹Ÿæ—¶ä½¿ç”¨çš„åŸºè¿›ç¨‹æ ‡è¯†(é€šå¸¸ï¼Œåœ¨ IIS 5 ä¸Šä¸º {MACHINE}\ASPNETï¼Œåœ¨ IIS 6 å’Œ IIS 7 ä¸Šä¸ºç½‘ç»œæœåŠ¡ï¼Œåœ¨ IIS 7.5 ä¸Šä¸ºé…ç½®çš„åº”ç”¨ç¨‹åºæ± æ ‡è¯†)ã€‚å¦‚æžœåº”ç”¨ç¨‹åºæ­£åœ¨é€šè¿‡ &lt;identity impersonate=&#34;true&#34;/&gt; æ¨¡æ‹Ÿï¼Œåˆ™æ ‡è¯†å°†ä¸ºåŒ¿åç”¨æˆ·(é€šå¸¸ä¸º IUSR_MACHINENAME)æˆ–ç»è¿‡èº«ä»½éªŒè¯çš„è¯·æ±‚ç”¨æˆ·ã€‚

  è¦å°† ASP.NET è®¿é—®æƒé™æŽˆäºˆæŸä¸ªæ–‡ä»¶ï¼Œè¯·åœ¨æ–‡ä»¶èµ„æºç®¡ç†å™¨ä¸­å³å‡»è¯¥æ–‡ä»¶ï¼Œé€‰æ‹©â€œå±žæ€§â€ï¼Œç„¶åŽé€‰æ‹©â€œå®‰å…¨â€é€‰é¡¹å¡ã€‚å•å‡»â€œæ·»åŠ â€æ·»åŠ é€‚å½“çš„ç”¨æˆ·æˆ–ç»„ã€‚çªå‡ºæ˜¾ç¤º ASP.NET å¸æˆ·ï¼Œé€‰ä¸­æ‰€éœ€è®¿é—®æƒé™å¯¹åº”çš„æ¡†ã€‚

  æºé”™è¯¯:

  æ‰§è¡Œå½“å‰ Web è¯·æ±‚æœŸé—´ç”Ÿæˆäº†æœªç»å¤„ç†çš„å¼‚å¸¸ã€‚å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å¼‚å¸¸å †æ ˆè·Ÿè¸ªä¿¡æ¯ç¡®å®šæœ‰å…³å¼‚å¸¸åŽŸå› å’Œå‘ç”Ÿä½ç½®çš„ä¿¡æ¯ã€‚

  å †æ ˆè·Ÿè¸ª:

  [DirectoryNotFoundException: æœªèƒ½æ‰¾åˆ°è·¯å¾„â€œxxxxxxâ€çš„ä¸€éƒ¨åˆ†ã€‚]
  System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath) &#43;490
  System.IO.FileStream.Init(String path, FileMode mode, FileAccess access, Int32 rights, Boolean useRights, FileShare share, Int32 bufferSize, FileOptions options, SECURITY_ATTRIBUTES secAttrs, String msgPath, Boolean bFromProxy, Boolean useLongPath, Boolean checkHost) &#43;833
  System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options, String msgPath, Boolean bFromProxy) &#43;144
  System.IO.FileStream..ctor(String path, FileMode mode) &#43;91
  HTYD.Merchant.Controllers.ExportController.DownloadFile(String fPath) in xxxx.cs:192
  System.Web.Mvc.&lt;&gt;c__DisplayClass1.&lt;WrapVoidAction&gt;b__0(ControllerBase controller, Object[] parameters) &#43;15
  .....
  ```
- è§£å†³æ–¹æ¡ˆ:  æ­¤é¡¹é—®é¢˜äº§ç”ŸåŽŸå› ä¸çŸ¥é“ï¼Œä½†è§£å†³æ–¹æ¡ˆæ˜¯ï¼Œä¸ºè¯¥ç›®å½•æ·»åŠ  `IIS_USER` ç”¨æˆ·æƒé™ï¼Œæ³¨æ„éœ€è¦é™„åŠ  `ä¿®æ”¹` æƒé™ 

# IIS ç«™ç‚¹è®¿é—®æŠ¥é”™, ç¼–è¯‘å™¨é”™è¯¯æ¶ˆæ¯: CS0016
- å¼‚å¸¸ä½“çŽ°: ç¼–è¯‘å™¨é”™è¯¯æ¶ˆæ¯: CS0016: æœªèƒ½å†™å…¥è¾“å‡ºæ–‡ä»¶â€œc:\Windows\Microsoft.NET\Framework64\v4.0.30319\Temporary ASP.NET Files\root\3469ad80\70ace2d2\App_global.asax.adikutzi.dllâ€--â€œæ‹’ç»è®¿é—®ã€‚ â€

- è§£å†³æ–¹æ¡ˆ: æ­¤é—®é¢˜çš„ç¡®ä¸ºæŽˆæƒé—®é¢˜å¯¼è‡´çš„ï¼Œä¸º C:\Windows\temp ç›®å½•ï¼Œæ·»åŠ  IIS_USER çš„å¸¸è§„æƒé™(å¯èƒ½è¦ç»†åˆ†æƒé™) å³å¯ 

---

> ä½œè€…: [0x5c0f](https://blog.0x5c0f.cc)  
> URL: https://blog.0x5c0f.cc/posts/linux/%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%BF%90%E7%BB%B4%E6%95%85%E9%9A%9C%E8%AE%B0%E5%BD%95/  

