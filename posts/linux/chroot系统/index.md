# Chroot系统


**以下是一片草稿，真的真的是我自己记录的。但是！我现在自己也看不懂了，我真是栓Q了，好像多了一个chroot初始没啥用**

# chroot系统 

**正常来说针对于文件共享的`sftp`应该是以用户为单位来做的,但这儿我却用的是组,这个其实是我测试用用户来做从来没有成功过，只能被迫用组**  
```bash
#!/bin/bash
################################################# 
#   author      0x5c0f 
#   date        2020-12-04 
#   email       mail@0x5c0f.cc 
#   web         blog.0x5c0f.cc
#   version     1.0.0
#   last update 2021-04-21
#   descript    Use : ./chroot.init.sh
################################################# 

PATH=/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin:/usr/local/sbin:~/bin
export PATH

# 用于在linux之间替代nfs系统 

# chroot 系统根目录 
CHROOTHOME=&#34;/chroot_sftp&#34; 


# sshfs 
# 用户配置
SSHFSUID=&#34;1050&#34;
SSHFSUSER=&#34;sshfs&#34;
SSHFSROOT=&#34;/home/${SSHFSUSER}&#34;

# sshfs chroot 映射目录
SSHFSCHROOTDIR=&#34;${CHROOTHOME}/sshfsdir&#34;
# sshfs 本地共享目录
SSHFSLOCALSHARE=&#34;/mnt/sshfsdir&#34;


function init_chroot(){
    test ! -d ${CHROOTHOME} &amp;&amp; {
        mkdir -p ${CHROOTHOME}/{bin,usr,etc,lib64,home,dev,data}  

        mknod -m 666 ${CHROOTHOME}/dev/null c 1 3  
        mknod -m 666 ${CHROOTHOME}/dev/tty c 5 0  
        mknod -m 666 ${CHROOTHOME}/dev/zero c 1 5  
        mknod -m 666 ${CHROOTHOME}/dev/random c 1 8  

        chmod o&#43;t ${CHROOTHOME}/dev/null ${CHROOTHOME}/dev/tty ${CHROOTHOME}/dev/zero ${CHROOTHOME}/dev/random  

        cd ${CHROOTHOME}/usr  
        ln -sf ../bin ./bin  
        ln -sf ../lib64 ./lib64  

        cp -p /bin/ls /bin/cat /bin/rm /bin/echo /bin/false /bin/touch /bin/vi /bin/mkdir  ${CHROOTHOME}/bin/  

        for i in /bin/{ls,cat,echo,rm,false,touch,vi,mkdir}; do  
            list=$(ldd ${i} | egrep -o &#39;/lib.*\.[0-9]&#39;) 

            for _so in $list; do 
                /bin/cp -v ${_so} ${CHROOTHOME}${_so} 
            done
        done  
    }
}

function config_sshd(){

    cat &gt;&gt; /etc/ssh/sshd_config &lt;&lt;EOE
Match $1  $2
    ChrootDirectory  $3
    ForceCommand internal-sftp -l INFO -f AUTH
    X11Forwarding no
    AllowTcpForwarding no
    PasswordAuthentication no

EOE

systemctl restart sshd
}

# 配置systemd管理模块
# $0 文件名 绑定目录 绑定目标目录 是否只读(默认为空: 读写)
# mount -o bind${4:&#43;,ro} 绑定目录 绑定目标目录
function config_systemd(){
    cat &gt; /etc/systemd/system/$1 &lt;&lt;EOF
# Automatically generated by systemd-fstab-generator

[Unit]
SourcePath=/etc/fstab
Documentation=man:fstab(5) man:systemd-fstab-generator(8)
Before=local-fs.target

[Mount]
What=${2}
Where=${3}
Type=none
Options=defaults,bind${4:&#43;,ro}

[Install]
WantedBy=multi-user.target

EOF

    systemctl daemon-reload 
    systemctl enable --now $1
}

# 初始化sftp可用组
function init_sshfs(){

    # 初始sshd配置
    config_sshd &#34;User&#34; $SSHFSUSER $SSHFSCHROOTDIR

    # 创建sshfs共享用户
    useradd -u ${SSHFSUID} -m -k $(mktemp -d) -d ${SSHFSROOT} -s /bin/false ${SSHFSUSER}

    # 创建远程登陆密钥 
    su - ${SSHFSUSER} -s /bin/bash -c &#34;ssh-keygen -f ~/.ssh/id_rsa -t rsa -b 4096 -N &#39;&#39;&#34;  
    su - ${SSHFSUSER} -s /bin/bash -c &#34;cat ~/.ssh/id_rsa.pub &gt; ~/.ssh/authorized_keys &amp;&amp; chmod 600 ~/.ssh/authorized_keys&#34;

    # 创建chroot sshfs共享目录 
    mkdir -p ${CHROOTHOME}${SSHFSROOT}

    # 绑定目录主目录
    # mount -o ro,bind ${SSHFSROOT} ${CHROOTHOME}${SSHFSROOT}
    # fstab
    # cat &gt;&gt; /etc/fstab &lt;&lt;EOF
    # ${SSHFSROOT} ${CHROOTHOME}${SSHFSROOT} none defaults,ro,bind 0 0
    # EOF

    SYSTEMDFNAME=&#34;${CHROOTHOME#/}${SSHFSROOT//\//-}.mount&#34;

    # 配置用户帐号映射
    config_systemd &#34;${SYSTEMDFNAME}&#34; &#34;${SSHFSROOT}&#34; &#34;${CHROOTHOME}${SSHFSROOT}&#34; 1

    # 配置sshfs目录映射 
    test ! -d ${SSHFSCHROOTDIR} &amp;&amp; {
        mkdir -p $SSHFSCHROOTDIR
    }

    test ! -d $SSHFSLOCALSHARE &amp;&amp; {
        mkdir -p $SSHFSLOCALSHARE
    }

    echo &#34;sshfs 共享目录 &#34; &gt; $SSHFSLOCALSHARE/readme.md
    
    TSSHFSCHROOTDIR=${SSHFSCHROOTDIR#/}
    config_systemd &#34;${TSSHFSCHROOTDIR//\//-}.mount&#34; &#34;${SSHFSLOCALSHARE}&#34; &#34;${SSHFSCHROOTDIR}&#34;

    # cat ${SSHFSROOT}/.ssh/id_rsa

}


init_chroot

# sshfs 
init_sshfs
```
## 节点服务器配置
```bash
# 开机启动项
$&gt; vim /etc/fstab
sshfsdir@10.0.2.30:/node21 /data/backup fuse.sshfs auto,reconnect,_netdev,user,idmap=user,identityfile=/etc/.ssh/sshfsdir,allow_other,default_permissions,uid=1002,gid=1002 0 0

# zabbix 监控 
$&gt; vim /opt/zabbix-agentd/etc/zabbix_agentd.conf.d/sshfs_status.conf 
UserParameter=sshfs_status,/bin/systemctl is-active data-ltbstore.mount &gt;&amp; /dev/null &amp;&amp; echo 0 || echo 1

```

---

> 作者: [0x5c0f](https://blog.0x5c0f.cc)  
> URL: https://blog.0x5c0f.cc/posts/linux/chroot%E7%B3%BB%E7%BB%9F/  

