

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" />
    <title>介绍在Linux命令行中使用tcpdump - 一个曾经的小码农...</title><meta name="Description" content="介绍在Linux命令行中使用tcpdump"><meta property="og:title" content="介绍在Linux命令行中使用tcpdump" />
<meta property="og:description" content="介绍在Linux命令行中使用tcpdump" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://blog.0x5c0f.cc/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/" /><meta property="og:image" content="https://blog.0x5c0f.cc/icons/logo_avatar.png"/><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2019-09-09T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-06-22T00:00:00+00:00" />


<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:image" content="https://blog.0x5c0f.cc/icons/logo_avatar.png"/>

<meta name="twitter:title" content="介绍在Linux命令行中使用tcpdump"/>
<meta name="twitter:description" content="介绍在Linux命令行中使用tcpdump"/>
<meta name="application-name" content="DoIt">
<meta name="apple-mobile-web-app-title" content="DoIt">

<meta name="theme-color" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="icon" href="/icons/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="canonical" href="https://blog.0x5c0f.cc/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/" /><link rel="prev" href="https://blog.0x5c0f.cc/2019/systemctl%E4%B9%8Bsystemd%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/" /><link rel="next" href="https://blog.0x5c0f.cc/2020/cobbler%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E5%AE%89%E8%A3%85/" /><link rel="stylesheet" href="/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/css/color.css"><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/fontawesome-free/all.min.css">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/animate/animate.min.css">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><meta name="google-site-verification" content="JntZ-myKUGeiVfETNSGA-pKc8nH1tdk4njyTVEjZzTs" /><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "介绍在Linux命令行中使用tcpdump",
        "inLanguage": "zh-CN",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/blog.0x5c0f.cc\/2019\/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump\/"
        },"genre": "posts","keywords": "linux, tcpdump","wordcount":  6155 ,
        "url": "https:\/\/blog.0x5c0f.cc\/2019\/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump\/","datePublished": "2019-09-09T00:00:00+00:00","dateModified": "2022-06-22T00:00:00+00:00","publisher": {
            "@type": "Organization",
            "name": "0x5c0f"},"authors": [{
                        "@type": "Person",
                        "name": "admin"                    
                    }],"description": "介绍在Linux命令行中使用tcpdump"
    }
    </script><script src="//instant.page/5.1.1" defer type="module" integrity="sha384-MWfCL6g1OTGsbSwfuMHc8+8J2u71/LA8dzlIN3ycajckxuZZmF+DNjdm7O6H3PSq"></script>
</head>

<body header-desktop="auto" header-mobile="auto"><script type="text/javascript">
        function setTheme(theme) {document.body.setAttribute('theme', theme); document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark'); window.theme = theme;   window.isDark = window.theme !== 'light' }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {let theme = localStorage.getItem('theme');theme === 'light' || theme === 'dark' || theme === 'black' ? setTheme(theme) : (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light')); } else { if ('auto' === 'light' || 'auto' === 'dark' || 'auto' === 'black') setTheme('auto'), saveTheme('auto'); else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');}
        let metaColors = {'light': '#f8f8f8','dark': '#252627','black': '#000000'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="一个曾经的小码农..."><img
        class="logo"
        loading="lazy"
        src="/icons/logo_title.png"
        srcset="/icons/logo_title.png, /icons/logo_title.png 1.5x, /icons/logo_title.png 2x"
        sizes="auto"
        alt="/icons/logo_title.png"
        title="/icons/logo_title.png" ><span id="desktop-header-typeit" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/"> 文章 </a><a class="menu-item" href="/tags/"> 标签 </a><a class="menu-item" href="/categories/"> 分类 </a><a class="menu-item" href="/series/"> 系列 </a><a class="menu-item" href="/about/"> About </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-desktop">
                        <a href="#" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-desktop" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </span><a href="#" class="menu-item theme-switch" title="切换主题">
                    <i class="fas fa-adjust fa-fw"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="一个曾经的小码农..."><img
        class="logo"
        loading="lazy"
        src="/icons/logo_title.png"
        srcset="/icons/logo_title.png, /icons/logo_title.png 1.5x, /icons/logo_title.png 2x"
        sizes="auto"
        alt="/icons/logo_title.png"
        title="/icons/logo_title.png" ><span id="mobile-header-typeit" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="搜索文章标题或内容..." id="search-input-mobile">
                        <a href="#" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                            <i class="fas fa-search fa-fw"></i>
                        </a>
                        <a href="#" class="search-button search-clear" id="search-clear-mobile" title="清空">
                            <i class="fas fa-times-circle fa-fw"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin"></i>
                        </span>
                    </div>
                    <a href="#" class="search-cancel" id="search-cancel-mobile">
                        取消
                    </a>
                </div><a class="menu-item" href="/posts/" title="">文章</a><a class="menu-item" href="/tags/" title="">标签</a><a class="menu-item" href="/categories/" title="">分类</a><a class="menu-item" href="/series/" title="">系列</a><a class="menu-item" href="/about/" title="">About</a><a href="#" class="menu-item theme-switch" title="切换主题">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
            <div class="container"><div class="toc" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content always-active" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-在linux上安装">1. 在Linux上安装</a></li>
    <li><a href="#2-使用tcpdump捕获数据包">2. 使用tcpdump捕获数据包</a></li>
    <li><a href="#3-理解输出格式">3. 理解输出格式</a></li>
    <li><a href="#4-过滤数据包">4. 过滤数据包</a>
      <ul>
        <li><a href="#41-protocol">4.1. Protocol</a></li>
        <li><a href="#42-host">4.2. Host</a></li>
        <li><a href="#43-port">4.3. Port</a></li>
      </ul>
    </li>
    <li><a href="#5-检查数据包的内容">5. 检查数据包的内容</a></li>
    <li><a href="#6-将捕获保存到文件">6. 将捕获保存到文件</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single"><h1 class="single-title animate__animated animate__flipInX">介绍在Linux命令行中使用tcpdump</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><span class='author'><i class="author fas fa-user-circle fa-fw"></i><span class='screen-reader-text'>  </span><a href='https://blog.0x5c0f.cc/authors/admin'>0x5c0f</a></span>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/linux/"><i class="far fa-folder fa-fw"></i>linux</a>&nbsp;<a href="/categories/%E6%95%B4%E7%90%86%E6%94%B6%E9%9B%86/"><i class="far fa-folder fa-fw"></i>整理收集</a></span>&nbsp;<span class="post-category">和</span>&nbsp;<span class="post-series">系列 <a href="/series/%E8%BF%90%E7%BB%B4%E8%AE%B0%E4%BA%8B/"><i class="far fa-list-alt fa-fw"></i>运维记事</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2019-09-09">2019-09-09</time>&nbsp;<i class="far fa-edit fa-fw"></i>&nbsp;<time datetime="2022-06-22">2022-06-22</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 6155 字&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 13 分钟&nbsp;<span id="/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/" class="leancloud_visitors" data-flag-title="介绍在Linux命令行中使用tcpdump">
                        <i class="far fa-eye fa-fw"></i>&nbsp;<span class="leancloud-visitors-count waline-pageview-count" data-path="/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/"></span>&nbsp;次阅读
                    </span>&nbsp;<span id="/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/" class="comment_count" data-flag-title="介绍在Linux命令行中使用tcpdump">
                        <i class="far fa-comments fa-fw"></i>&nbsp;<span class="waline-comment-count" id="waline-comment-count" data-path="/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/"></span>&nbsp;条评论
                    </span>&nbsp;<span>
                        <i class="fas fa-balance-scale fa-fw"></i>&nbsp;<span><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a></span>&nbsp;
                    </span>&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-在linux上安装">1. 在Linux上安装</a></li>
    <li><a href="#2-使用tcpdump捕获数据包">2. 使用tcpdump捕获数据包</a></li>
    <li><a href="#3-理解输出格式">3. 理解输出格式</a></li>
    <li><a href="#4-过滤数据包">4. 过滤数据包</a>
      <ul>
        <li><a href="#41-protocol">4.1. Protocol</a></li>
        <li><a href="#42-host">4.2. Host</a></li>
        <li><a href="#43-port">4.3. Port</a></li>
      </ul>
    </li>
    <li><a href="#5-检查数据包的内容">5. 检查数据包的内容</a></li>
    <li><a href="#6-将捕获保存到文件">6. 将捕获保存到文件</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><div class="details admonition warning open">
                <div class="details-summary admonition-title">
                    <i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i>
                </div>
                <div class="details-content">
                    <div class="admonition-content">
                        本文最后更新于 <span class="timeago" datetime="2022-06-22T00:00:00" title="June 22, 2022">2022-06-22</span>，文中内容可能已过时。</div>
                </div>
            </div><div class="details admonition quote open">
        <div class="details-summary admonition-title">
            <i class="icon fas fa-quote-right fa-fw"></i>引用<i class="details-icon fas fa-angle-right fa-fw"></i>
        </div>
        <div class="details-content">
            <div class="admonition-content"><p>介绍在Linux命令行中使用tcpdump<br>
文章原文来源 <a href="https://opensource.com" target="_blank" rel="noopener noreferrer">opensource.com</a>, 由本站翻译发布用于个人搜集。</p>
<blockquote>
<p><a href="https://opensource.com/article/18/10/introduction-tcpdump" target="_blank" rel="noopener noreferrer">https://opensource.com/article/18/10/introduction-tcpdump</a></p>
</blockquote>
</div>
        </div>
    </div>
<p><code>tcpdump</code>是一个功能强大、功能多样的工具，包括许多选项和过滤器，可以在各种情况下使用。由于它是一个命令行工具，所以最好在没有<code>GUI</code>的远程服务器或设备上运行，以便收集可以稍后分析的数据。它也可以在后台启动，或者使用<code>cron</code>之类的工具作为计划作业启动。</p>
<p>在本文中，我们将介绍一些<code>tcpdump</code>最常见的功能。</p>
<h1 id="1-在linux上安装" class="headerLink">
    <a href="#1-%e5%9c%a8linux%e4%b8%8a%e5%ae%89%e8%a3%85" class="header-mark"></a>1. 在Linux上安装</h1><p><code>Tcpdump</code>包含在几个<code>Linux</code>发行版中，所以您可能已经安装了它。使用以下命令检查系统是否已安装<code>tcpdump</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; which tcpdump
</span></span><span class="line"><span class="cl">/usr/sbin/tcpdump
</span></span></code></pre></td></tr></table>
</div>
</div><p>如果没有安装<code>tcpdump</code>，可以使用发行版的包管理器安装它。例如，在<code>CentOS</code>或<code>Red Hat Enterprise Linux</code>上，如下所示:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo yum install -y tcpdump
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Tcpdump</code>需要<code>libpcap</code>，这是一个用于网络包捕获的库。如果没有安装，它将自动作为依赖项添加。</p>
<p>你已经准备好开始捕获一些包了么。</p>
<h1 id="2-使用tcpdump捕获数据包" class="headerLink">
    <a href="#2-%e4%bd%bf%e7%94%a8tcpdump%e6%8d%95%e8%8e%b7%e6%95%b0%e6%8d%ae%e5%8c%85" class="header-mark"></a>2. 使用tcpdump捕获数据包</h1><p>要捕获用于故障排除或分析的包，<code>tcpdump</code>需要提高权限，因此在下面的示例中，大多数命令都以<code>sudo</code>作为前缀。</p>
<p>首先，使用命令<code>tcpdump -D</code>查看哪些接口可用来捕获:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -D 
</span></span><span class="line"><span class="cl">1.eth0
</span></span><span class="line"><span class="cl">2.virbr0
</span></span><span class="line"><span class="cl">3.eth1
</span></span><span class="line"><span class="cl">4.any <span class="o">(</span>Pseudo-device that captures on all interfaces<span class="o">)</span>
</span></span><span class="line"><span class="cl">5.lo <span class="o">[</span>Loopback<span class="o">]</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在上面的示例中，您可以看到我的机器中所有可用的接口。特殊接口<code>any</code>允许在任何活动接口中捕获。
让我们使用它开始捕获一些包。通过运行以下命令捕获任何接口中的所有数据包 :</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">09:56:18.293641 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 3770820720:3770820916, ack 3503648727, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">76577898</span> ecr 510770929<span class="o">]</span>, length <span class="m">196</span>
</span></span><span class="line"><span class="cl">09:56:18.293794 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags <span class="o">[</span>.<span class="o">]</span>, ack 196, win 391, options <span class="o">[</span>nop,nop,TS val <span class="m">510771017</span> ecr 76577898<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:56:18.295058 IP rhel75.59883 &gt; gateway.domain: 2486+ PTR? 1.64.168.192.in-addr.arpa. <span class="o">(</span>43<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.310225 IP gateway.domain &gt; rhel75.59883: <span class="m">2486</span> NXDomain* 0/1/0 <span class="o">(</span>102<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.312482 IP rhel75.49685 &gt; gateway.domain: 34242+ PTR? 28.64.168.192.in-addr.arpa. <span class="o">(</span>44<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.322425 IP gateway.domain &gt; rhel75.49685: <span class="m">34242</span> NXDomain* 0/1/0 <span class="o">(</span>103<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.323164 IP rhel75.56631 &gt; gateway.domain: 29904+ PTR? 1.122.168.192.in-addr.arpa. <span class="o">(</span>44<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.323342 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 196:584, ack 1, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">76577928</span> ecr 510771017<span class="o">]</span>, length <span class="m">388</span>
</span></span><span class="line"><span class="cl">09:56:18.323563 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags <span class="o">[</span>.<span class="o">]</span>, ack 584, win 411, options <span class="o">[</span>nop,nop,TS val <span class="m">510771047</span> ecr 76577928<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:56:18.335569 IP gateway.domain &gt; rhel75.56631: <span class="m">29904</span> NXDomain* 0/1/0 <span class="o">(</span>103<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.336429 IP rhel75.44007 &gt; gateway.domain: 61677+ PTR? 98.122.168.192.in-addr.arpa. <span class="o">(</span>45<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.336655 IP gateway.domain &gt; rhel75.44007: 61677* 1/0/0 PTR rhel75. <span class="o">(</span>65<span class="o">)</span>
</span></span><span class="line"><span class="cl">09:56:18.337177 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 584:1644, ack 1, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">76577942</span> ecr 510771047<span class="o">]</span>, length <span class="m">1060</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">---- SKIPPING LONG OUTPUT -----
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">09:56:19.342939 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1752016, win 1444, options <span class="o">[</span>nop,nop,TS val <span class="m">510772067</span> ecr 76578948<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">^C
</span></span><span class="line"><span class="cl"><span class="m">9003</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">9010</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">7</span> packets dropped by kernel
</span></span><span class="line"><span class="cl">$&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>Tcpdump</code>继续捕获数据包，直到它接收到中断信号。您可以按<code>Ctrl+C</code>中断捕获。在这个例子中可以看到，<code>tcpdump</code>捕获了超过9,000个包。在本例中，由于我使用<code>ssh</code>连接到此服务器，所以<code>tcpdump</code>捕获了所有这些包。若要限制捕获的数据包数量并停止<code>tcpdump</code>，请使用<code>-c</code>选项:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c <span class="m">5</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">11:21:30.242740 IP rhel75.localdomain.ssh &gt; 192.168.64.1.56322: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 3772575680:3772575876, ack 3503651743, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">81689848</span> ecr 515883153<span class="o">]</span>, length <span class="m">196</span>
</span></span><span class="line"><span class="cl">11:21:30.242906 IP 192.168.64.1.56322 &gt; rhel75.localdomain.ssh: Flags <span class="o">[</span>.<span class="o">]</span>, ack 196, win 1443, options <span class="o">[</span>nop,nop,TS val <span class="m">515883235</span> ecr 81689848<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">11:21:30.244442 IP rhel75.43634 &gt; gateway.domain: 57680+ PTR? 1.64.168.192.in-addr.arpa. <span class="o">(</span>43<span class="o">)</span>
</span></span><span class="line"><span class="cl">11:21:30.244829 IP gateway.domain &gt; rhel75.43634: <span class="m">57680</span> NXDomain 0/0/0 <span class="o">(</span>43<span class="o">)</span>
</span></span><span class="line"><span class="cl">11:21:30.247048 IP rhel75.33696 &gt; gateway.domain: 37429+ PTR? 28.64.168.192.in-addr.arpa. <span class="o">(</span>44<span class="o">)</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">12</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="cl">$&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>在本例中，<code>tcpdump</code>在捕获5个包之后自动停止捕获。这在不同的场景中都很有用——例如，如果您正在对连接进行故障诊断，并且捕获几个初始包就足够了。当我们应用过滤器来捕获特定的包时，这甚至更有用(如下所示)。</p>
<p>默认情况下，<code>tcpdump</code>将IP地址和端口解析为名称，如前面的示例所示。在排除网络问题时，通常更容易使用IP地址和端口号; 禁用名称解析使用选项<code>-n</code>和端口解析与<code>-nn</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">23:56:24.292206 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 166198580:166198776, ack 2414541257, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">615664</span> ecr 540031155<span class="o">]</span>, length <span class="m">196</span>
</span></span><span class="line"><span class="cl">23:56:24.292357 IP 192.168.64.1.35110 &gt; 192.168.64.28.22: Flags <span class="o">[</span>.<span class="o">]</span>, ack 196, win 1377, options <span class="o">[</span>nop,nop,TS val <span class="m">540031229</span> ecr 615664<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">23:56:24.292570 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 196:568, ack 1, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">615664</span> ecr 540031229<span class="o">]</span>, length <span class="m">372</span>
</span></span><span class="line"><span class="cl">23:56:24.292655 IP 192.168.64.1.35110 &gt; 192.168.64.28.22: Flags <span class="o">[</span>.<span class="o">]</span>, ack 568, win 1400, options <span class="o">[</span>nop,nop,TS val <span class="m">540031229</span> ecr 615664<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">23:56:24.292752 IP 192.168.64.28.22 &gt; 192.168.64.1.35110: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 568:908, ack 1, win 309, options <span class="o">[</span>nop,nop,TS val <span class="m">615664</span> ecr 540031229<span class="o">]</span>, length <span class="m">340</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">6</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><p>如上所示，捕获输出现在显示IP地址和端口号。这还可以防止<code>tcpdump</code>发出<code>DNS</code>查询，这有助于在排除网络问题时降低网络流量。</p>
<p>现在您已经能够捕获网络数据包，让我们来研究一下这个输出意味着什么。</p>
<h1 id="3-理解输出格式" class="headerLink">
    <a href="#3-%e7%90%86%e8%a7%a3%e8%be%93%e5%87%ba%e6%a0%bc%e5%bc%8f" class="header-mark"></a>3. 理解输出格式</h1><p><code>Tcpdump</code>能够捕获和解码许多不同的协议，比如<code>TCP</code>、<code>UDP</code>、<code>ICMP</code>等等。虽然我们不能在这里全部介绍，但是为了帮助您入门，让我们研究一下TCP包。您可以在<code>tcpdump</code>的手册页中找到关于不同协议格式的更多细节。<code>tcpdump</code>捕获的典型<code>TCP</code>包是这样的:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">08:41:13.729687 IP 192.168.64.28.22 &gt; 192.168.64.1.41916: Flags [P.], seq 196:568, ack 1, win 309, options [nop,nop,TS val 117964079 ecr 816509256], length 372
</span></span></code></pre></td></tr></table>
</div>
</div><p>字段可能因发送的包的类型而异，但这是一般格式。<br>
第一个字段<code>08:41:13.729687</code>表示根据本地时钟接收到的数据包的时间戳。<br>
接下来，<code>IP</code>表示网络层协议——在本例中是<code>IPv4</code>。对于<code>IPv6</code>数据包，值是<code>IP6</code>。<br>
下一个字段<code>192.168.64.28.22</code>是源IP地址和端口。然后是目标IP地址和端口，由<code>192.168.64.1.41916</code>表示。</p>
<p>在源和目标之后，您可以找到<code>TCP</code>标志标志<code>[P.]</code>。该字段的典型值包括:</p>
<table>
<thead>
<tr>
<th>值</th>
<th>标志类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>S</code></td>
<td><code>SYN</code></td>
<td><code>Connection Start</code></td>
</tr>
<tr>
<td><code>F</code></td>
<td><code>FIN</code></td>
<td><code>Connection Finish</code></td>
</tr>
<tr>
<td><code>P</code></td>
<td><code>PUSH</code></td>
<td><code>Data push</code></td>
</tr>
<tr>
<td><code>R</code></td>
<td><code>RST</code></td>
<td><code>Connection reset</code></td>
</tr>
<tr>
<td><code>.</code></td>
<td><code>ACK</code></td>
<td><code>Acknowledgment</code></td>
</tr>
</tbody>
</table>
<p>This field can also be a combination of these values, such as [S.] for a SYN-ACK pack
The next field is the window size win 309, which represents the number of bytes available in the receiving buffer, followed by TCP options such as the MSS (Maximum Segment Size) or Window Scale. For details about TCP protocol options, consult Transmission Control Protocol (TCP) Parameters.</p>
<p>Finally, we have the packet length, length 372, which represents the length, in bytes, of the payload data. The length is the difference between the last and first bytes in the sequence number.</p>
<p>Now let&rsquo;s learn how to filter packets to narrow down results and make it easier to troubleshoot specific issues.</p>
<p>该字段也可以是这些值的组合，例如用于<code>SYN-ACK</code>分组的<code>[S.]</code>。<br>
接下来是数据包中包含的数据的序列号。对于捕获的第一个包，这是一个绝对值。随后的数据包使用一个相对号，以便更容易跟踪。在这个例子中，序列是<code>seq 196:568</code>，这意味着这个包包含这个流的<code>196</code>到<code>568</code>字节。<br>
然后是<code>Ack</code>编号:<code>Ack 1</code>。在本例中，它是1，因为这是发送数据的一方。对于接收数据的端，此字段表示此流上的下一个预期字节(数据)。例如，这个流中的下一个包的<code>Ack</code>号将是<code>568</code>。<br>
下一个字段是窗口大小<code>win 309</code>，它表示接收缓冲区中可用的字节数，然后是<code>TCP</code>选项，如<code>MSS</code>(最大段大小)或窗口大小。有关TCP协议选项的详细信息，请参阅<a href="https://www.iana.org/assignments/tcp-parameters/tcp-parameters.xhtml" target="_blank" rel="noopener noreferrer">传输控制协议(TCP)参数</a>。<br>
最后，我们有数据包长度，长度<code>372</code>，它表示负载数据的长度，以字节为单位。长度是序号中最后一个字节和第一个字节之间的差。<br>
现在，让我们学习如何过滤数据包以缩小结果范围，并使特定问题的故障排除变得更容易。</p>
<h1 id="4-过滤数据包" class="headerLink">
    <a href="#4-%e8%bf%87%e6%bb%a4%e6%95%b0%e6%8d%ae%e5%8c%85" class="header-mark"></a>4. 过滤数据包</h1><p>如上所述，<code>tcpdump</code>可以捕获太多包，其中一些包甚至与您正在排除的问题无关。例如，如果您正在排除与web服务器的连接问题，而您对SSH流量不感兴趣，因此从输出中删除SSH数据包可以更容易地处理真正的问题。</p>
<p><code>tcpdump</code>最强大的特性之一是它能够使用各种参数(如源和目标IP地址、端口、协议等)过滤捕获的数据包。让我们来看看一些最常见的。</p>
<h2 id="41-protocol" class="headerLink">
    <a href="#41-protocol" class="header-mark"></a>4.1. Protocol</h2><p>要基于协议过滤数据包，请在命令行中指定协议。例如，使用以下命令用于捕获<code>ICMP</code>数据包:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 icmp
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span></code></pre></td></tr></table>
</div>
</div><p>在另一个终端，尝试ping另一台机器:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; ping opensource.com
</span></span><span class="line"><span class="cl">PING opensource.com <span class="o">(</span>54.204.39.132<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span></span><span class="line"><span class="cl"><span class="m">64</span> bytes from ec2-54-204-39-132.compute-1.amazonaws.com <span class="o">(</span>54.204.39.132<span class="o">)</span>: <span class="nv">icmp_seq</span><span class="o">=</span><span class="m">1</span> <span class="nv">ttl</span><span class="o">=</span><span class="m">47</span> <span class="nv">time</span><span class="o">=</span>39.6 ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>回到<code>tcpdump</code>捕获中，注意<code>tcpdump</code>只捕获和显示与<code>icmp</code>相关的包。在这种情况下，<code>tcpdump</code>不显示解析<code>opensource.com</code>时生成的名称解析包:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">09:34:20.136766 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="nb">echo</span> request, id 20361, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">09:34:20.176402 IP ec2-54-204-39-132.compute-1.amazonaws.com &gt; rhel75: ICMP <span class="nb">echo</span> reply, id 20361, seq 1, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">09:34:21.140230 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="nb">echo</span> request, id 20361, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">09:34:21.180020 IP ec2-54-204-39-132.compute-1.amazonaws.com &gt; rhel75: ICMP <span class="nb">echo</span> reply, id 20361, seq 2, length <span class="m">64</span>
</span></span><span class="line"><span class="cl">09:34:22.141777 IP rhel75 &gt; ec2-54-204-39-132.compute-1.amazonaws.com: ICMP <span class="nb">echo</span> request, id 20361, seq 3, length <span class="m">64</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="42-host" class="headerLink">
    <a href="#42-host" class="header-mark"></a>4.2. Host</h2><p>使用主机过滤器将捕获限制为只与特定主机相关的数据包:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn host 54.204.39.132
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">09:54:20.042023 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 1375157070, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">122350391</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:54:20.088127 IP 54.204.39.132.80 &gt; 192.168.122.98.39326: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 1935542841, ack 1375157071, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">522713542</span> ecr 122350391,nop,wscale 9<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:54:20.088204 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">122350437</span> ecr 522713542<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:54:20.088734 IP 192.168.122.98.39326 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:113, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">122350438</span> ecr 522713542<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">09:54:20.129733 IP 54.204.39.132.80 &gt; 192.168.122.98.39326: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">522713552</span> ecr 122350438<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><p>在此实例中，<code>tcpdump</code>只捕获和显示主机<code>54.204.39.132</code>之间的数据包</p>
<h2 id="43-port" class="headerLink">
    <a href="#43-port" class="header-mark"></a>4.3. Port</h2><p>要根据所需的服务或端口过滤数据包，请使用端口过滤器。例如，使用以下命令捕获与web (HTTP)服务相关的数据包:　　</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn port <span class="m">80</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">09:58:28.790548 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 1745665159, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">122599140</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:58:28.834026 IP 54.204.39.132.80 &gt; 192.168.122.98.39330: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 4063583040, ack 1745665160, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">522775728</span> ecr 122599140,nop,wscale 9<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:58:28.834093 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">122599183</span> ecr 522775728<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">09:58:28.834588 IP 192.168.122.98.39330 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:113, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">122599184</span> ecr 522775728<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">09:58:28.878445 IP 54.204.39.132.80 &gt; 192.168.122.98.39330: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">522775739</span> ecr 122599184<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="cl">Source IP/hostname
</span></span></code></pre></td></tr></table>
</div>
</div><p>你还可以根据源或目标IP地址或主机名过滤数据包。例如，从主机<code>192.168.122.98</code>捕获数据包:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn src 192.168.122.98
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">10:02:15.220824 IP 192.168.122.98.39436 &gt; 192.168.122.1.53: 59332+ A? opensource.com. <span class="o">(</span>32<span class="o">)</span>
</span></span><span class="line"><span class="cl">10:02:15.220862 IP 192.168.122.98.39436 &gt; 192.168.122.1.53: 20749+ AAAA? opensource.com. <span class="o">(</span>32<span class="o">)</span>
</span></span><span class="line"><span class="cl">10:02:15.364062 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 1108640533, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">122825713</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:02:15.409229 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 669337581, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">122825758</span> ecr 522832372<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:02:15.409667 IP 192.168.122.98.39334 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 0:112, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">122825759</span> ecr 522832372<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><p>注意，tcpdump捕获的数据包的源IP地址为<code>192.168.122.98</code>，用于多个服务，比如名称解析(端口53)和HTTP(端口80)。响应包不显示，因为它们的源IP不同。</p>
<p>相反，您可以使用<code>dst</code>过滤器按目标IP/主机名进行过滤：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn dst 192.168.122.98
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">10:05:03.572931 IP 192.168.122.1.53 &gt; 192.168.122.98.47049: <span class="m">2248</span> 1/0/0 A 54.204.39.132 <span class="o">(</span>48<span class="o">)</span>
</span></span><span class="line"><span class="cl">10:05:03.572944 IP 192.168.122.1.53 &gt; 192.168.122.98.47049: <span class="m">33770</span> 0/0/0 <span class="o">(</span>32<span class="o">)</span>
</span></span><span class="line"><span class="cl">10:05:03.621833 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 3474204576, ack 3256851264, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">522874425</span> ecr 122993922,nop,wscale 9<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:05:03.667767 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">522874436</span> ecr 122993972<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:05:03.672221 IP 54.204.39.132.80 &gt; 192.168.122.98.39338: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:643, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">522874437</span> ecr 122993972<span class="o">]</span>, length 642: HTTP: HTTP/1.1 <span class="m">302</span> Found
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span><span class="line"><span class="cl">Complex expressions
</span></span></code></pre></td></tr></table>
</div>
</div><p>您还可以通过使用逻辑运算符和and或创建更复杂的表达式来组合过滤器。例如，要从源IP地址<code>192.168.122.98</code>和服务HTTP中过滤数据包，请使用以下命令:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn src 192.168.122.98 and port <span class="m">80</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">10:08:00.472696 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 2712685325, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">123170822</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:08:00.516118 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 268723504, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">123170865</span> ecr 522918648<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:08:00.516583 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 0:112, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">123170866</span> ecr 522918648<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10:08:00.567044 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 643, win 239, options <span class="o">[</span>nop,nop,TS val <span class="m">123170916</span> ecr 522918661<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:08:00.788153 IP 192.168.122.98.39342 &gt; 54.204.39.132.80: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 112, ack 643, win 239, options <span class="o">[</span>nop,nop,TS val <span class="m">123171137</span> ecr 522918661<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><p>您可以通过使用括号对<code>filter</code>进行分组来创建更复杂的表达式。在这种情况下，用引号括住整个过滤器表达式，以防止<code>shell</code>将它们与<code>shell</code>表达式混淆:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c5 -nn <span class="s2">&#34;port 80 and (src 192.168.122.98 or src 54.204.39.132)&#34;</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">10:10:37.602214 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 871108679, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">123327951</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:10:37.650651 IP 54.204.39.132.80 &gt; 192.168.122.98.39346: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 854753193, ack 871108680, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">522957932</span> ecr 123327951,nop,wscale 9<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:10:37.650708 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">123328000</span> ecr 522957932<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">10:10:37.651097 IP 192.168.122.98.39346 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:113, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">123328000</span> ecr 522957932<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">10:10:37.692900 IP 54.204.39.132.80 &gt; 192.168.122.98.39346: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">522957942</span> ecr 123328000<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">5</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><p>在本例中，我们只过滤HTTP服务(端口80)和源IP地址<code>192.168.122.98</code>或<code>54.204.39.132</code>的数据包。这是检查同一流的两边的一种快速方法。</p>
<h1 id="5-检查数据包的内容" class="headerLink">
    <a href="#5-%e6%a3%80%e6%9f%a5%e6%95%b0%e6%8d%ae%e5%8c%85%e7%9a%84%e5%86%85%e5%ae%b9" class="header-mark"></a>5. 检查数据包的内容</h1><p>在前面的示例中，我们只检查信息包的头信息，如源、目标、端口等。有时，这就是我们解决网络连接问题所需要的全部内容。然而，有时我们需要检查包的内容，以确保我们发送的消息包含我们需要的内容，或者我们收到了预期的响应。要查看包内容，tcpdump提供了两个附加标志:-X以十六进制打印内容，ASCII或-A以ASCII打印内容。</p>
<p>例如，检查Web请求的HTTP内容，如下所示：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c10 -nn -A port <span class="m">80</span>
</span></span><span class="line"><span class="cl">tcpdump: verbose output suppressed, use -v or -vv <span class="k">for</span> full protocol decode
</span></span><span class="line"><span class="cl">listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl">13:02:14.871803 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 2546602048, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">133625221</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">E..&lt;..@.@.....zb6.<span class="s1">&#39;....P...@......r............
</span></span></span><span class="line"><span class="cl"><span class="s1">............................
</span></span></span><span class="line"><span class="cl"><span class="s1">13:02:14.910734 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [S.], seq 1877348646, ack 2546602049, win 28960, options [mss 1460,sackOK,TS val 525532247 ecr 133625221,nop,wscale 9], length 0
</span></span></span><span class="line"><span class="cl"><span class="s1">E..&lt;..@./..a6.&#39;</span>...zb.P..o..<span class="p">&amp;</span>...A..q a..........
</span></span><span class="line"><span class="cl">.R.W.......     ................
</span></span><span class="line"><span class="cl">13:02:14.910832 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">133625260</span> ecr 525532247<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">E..4..@.@.....zb6.<span class="s1">&#39;....P...Ao..&#39;</span>...........
</span></span><span class="line"><span class="cl">.....R.W................
</span></span><span class="line"><span class="cl">13:02:14.911808 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:113, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">133625261</span> ecr 525532247<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">E.....@.@..1..zb6.<span class="s1">&#39;....P...Ao..&#39;</span>...........
</span></span><span class="line"><span class="cl">.....R.WGET / HTTP/1.1
</span></span><span class="line"><span class="cl">User-Agent: Wget/1.14 <span class="o">(</span>linux-gnu<span class="o">)</span>
</span></span><span class="line"><span class="cl">Accept: */*
</span></span><span class="line"><span class="cl">Host: opensource.com
</span></span><span class="line"><span class="cl">Connection: Keep-Alive
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">................
</span></span><span class="line"><span class="cl">13:02:14.951199 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">525532257</span> ecr 133625261<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">E..4.F@./..<span class="s2">&#34;6.&#39;...zb.P..o..&#39;.......9.2.....
</span></span></span><span class="line"><span class="cl"><span class="s2">.R.a....................
</span></span></span><span class="line"><span class="cl"><span class="s2">13:02:14.955030 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [P.], seq 1:643, ack 113, win 57, options [nop,nop,TS val 525532258 ecr 133625261], length 642: HTTP: HTTP/1.1 302 Found
</span></span></span><span class="line"><span class="cl"><span class="s2">E....G@./...6.&#39;...zb.P..o..&#39;.......9.......
</span></span></span><span class="line"><span class="cl"><span class="s2">.R.b....HTTP/1.1 302 Found
</span></span></span><span class="line"><span class="cl"><span class="s2">Server: nginx
</span></span></span><span class="line"><span class="cl"><span class="s2">Date: Sun, 23 Sep 2018 17:02:14 GMT
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Type: text/html; charset=iso-8859-1
</span></span></span><span class="line"><span class="cl"><span class="s2">Content-Length: 207
</span></span></span><span class="line"><span class="cl"><span class="s2">X-Content-Type-Options: nosniff
</span></span></span><span class="line"><span class="cl"><span class="s2">Location: https://opensource.com/
</span></span></span><span class="line"><span class="cl"><span class="s2">Cache-Control: max-age=1209600
</span></span></span><span class="line"><span class="cl"><span class="s2">Expires: Sun, 07 Oct 2018 17:02:14 GMT
</span></span></span><span class="line"><span class="cl"><span class="s2">X-Request-ID: v-6baa3acc-bf52-11e8-9195-22000ab8cf2d
</span></span></span><span class="line"><span class="cl"><span class="s2">X-Varnish: 632951979
</span></span></span><span class="line"><span class="cl"><span class="s2">Age: 0
</span></span></span><span class="line"><span class="cl"><span class="s2">Via: 1.1 varnish (Varnish/5.2)
</span></span></span><span class="line"><span class="cl"><span class="s2">X-Cache: MISS
</span></span></span><span class="line"><span class="cl"><span class="s2">Connection: keep-alive
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;!DOCTYPE HTML PUBLIC &#34;</span>-//IETF//DTD HTML 2.0//EN<span class="s2">&#34;&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;html&gt;&lt;head&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;title&gt;302 Found&lt;/title&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/head&gt;&lt;body&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;h1&gt;Found&lt;/h1&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;p&gt;The document has moved &lt;a href=&#34;</span>https://opensource.com/<span class="s2">&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">&lt;/body&gt;&lt;/html&gt;
</span></span></span><span class="line"><span class="cl"><span class="s2">................
</span></span></span><span class="line"><span class="cl"><span class="s2">13:02:14.955083 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 643, win 239, options [nop,nop,TS val 133625304 ecr 525532258], length 0
</span></span></span><span class="line"><span class="cl"><span class="s2">E..4..@.@.....zb6.&#39;....P....o..............
</span></span></span><span class="line"><span class="cl"><span class="s2">.....R.b................
</span></span></span><span class="line"><span class="cl"><span class="s2">13:02:15.195524 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [F.], seq 113, ack 643, win 239, options [nop,nop,TS val 133625545 ecr 525532258], length 0
</span></span></span><span class="line"><span class="cl"><span class="s2">E..4..@.@.....zb6.&#39;....P....o..............
</span></span></span><span class="line"><span class="cl"><span class="s2">.....R.b................
</span></span></span><span class="line"><span class="cl"><span class="s2">13:02:15.236592 IP 54.204.39.132.80 &gt; 192.168.122.98.39366: Flags [F.], seq 643, ack 114, win 57, options [nop,nop,TS val 525532329 ecr 133625545], length 0
</span></span></span><span class="line"><span class="cl"><span class="s2">E..4.H@./.. 6.&#39;...zb.P..o..........9.I.....
</span></span></span><span class="line"><span class="cl"><span class="s2">.R......................
</span></span></span><span class="line"><span class="cl"><span class="s2">13:02:15.236656 IP 192.168.122.98.39366 &gt; 54.204.39.132.80: Flags [.], ack 644, win 239, options [nop,nop,TS val 133625586 ecr 525532329], length 0
</span></span></span><span class="line"><span class="cl"><span class="s2">E..4..@.@.....zb6.&#39;....P....o..............
</span></span></span><span class="line"><span class="cl"><span class="s2">.....R..................
</span></span></span><span class="line"><span class="cl"><span class="s2">10 packets captured
</span></span></span><span class="line"><span class="cl"><span class="s2">10 packets received by filter
</span></span></span><span class="line"><span class="cl"><span class="s2">0 packets dropped by kernel
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>假设调用使用普通HTTP，这对于解决API调用的问题很有帮助。对于加密连接，这个输出就不那么有用了。</p>
<h1 id="6-将捕获保存到文件" class="headerLink">
    <a href="#6-%e5%b0%86%e6%8d%95%e8%8e%b7%e4%bf%9d%e5%ad%98%e5%88%b0%e6%96%87%e4%bb%b6" class="header-mark"></a>6. 将捕获保存到文件</h1><p><code>tcpdump</code>提供的另一个有用特性是能够将捕获保存到文件中，以便稍后分析结果。例如，这允许您在夜间以批处理模式捕获数据包，并在早晨验证结果。当有太多包需要分析时，它也会有帮助，因为实时捕获可能发生得太快。<br>
要将数据包保存到文件中，而不是显示在屏幕上，请使用选项<code>-w</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; sudo tcpdump -i any -c10 -nn -w webserver.pcap port <span class="m">80</span>
</span></span><span class="line"><span class="cl"><span class="o">[</span>sudo<span class="o">]</span> password <span class="k">for</span> ricardo:
</span></span><span class="line"><span class="cl">tcpdump: listening on any, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>, capture size <span class="m">262144</span> bytes
</span></span><span class="line"><span class="cl"><span class="m">10</span> packets captured
</span></span><span class="line"><span class="cl"><span class="m">10</span> packets received by filter
</span></span><span class="line"><span class="cl"><span class="m">0</span> packets dropped by kernel
</span></span></code></pre></td></tr></table>
</div>
</div><p>这个命令将输出保存在一个名为<code>webserver.pcap</code>的文件中。<code>pcap</code>扩展名代表“包捕获”，是这种文件格式的约定。<br>
如本例所示，屏幕上没有显示任何内容，捕获在捕获10个包之后完成，这与选项<code>-c10</code>相同。如果您想要一些反馈以确保正在捕获数据包，请使用选项<code>-v</code>。<br>
<code>Tcpdump</code>创建二进制格式的文件，因此不能简单地使用文本编辑器打开它。要读取文件内容，请使用<code>-r</code>选项执行<code>tcpdump</code>:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; tcpdump -nn -r webserver.pcap
</span></span><span class="line"><span class="cl">reading from file webserver.pcap, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>
</span></span><span class="line"><span class="cl">13:36:57.679494 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags <span class="o">[</span>S<span class="o">]</span>, seq 3709732619, win 29200, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">135708029</span> ecr 0,nop,wscale 7<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.718932 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 1999298316, ack 3709732620, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">526052949</span> ecr 135708029,nop,wscale 9<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.719005 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">135708068</span> ecr 526052949<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.719186 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:113, ack 1, win 229, options <span class="o">[</span>nop,nop,TS val <span class="m">135708068</span> ecr 526052949<span class="o">]</span>, length 112: HTTP: GET / HTTP/1.1
</span></span><span class="line"><span class="cl">13:36:57.756979 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">526052959</span> ecr 135708068<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.760122 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:643, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">526052959</span> ecr 135708068<span class="o">]</span>, length 642: HTTP: HTTP/1.1 <span class="m">302</span> Found
</span></span><span class="line"><span class="cl">13:36:57.760182 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 643, win 239, options <span class="o">[</span>nop,nop,TS val <span class="m">135708109</span> ecr 526052959<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.977602 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 113, ack 643, win 239, options <span class="o">[</span>nop,nop,TS val <span class="m">135708327</span> ecr 526052959<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:58.022089 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 643, ack 114, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">526053025</span> ecr 135708327<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:58.022132 IP 192.168.122.98.39378 &gt; 54.204.39.132.80: Flags <span class="o">[</span>.<span class="o">]</span>, ack 644, win 239, options <span class="o">[</span>nop,nop,TS val <span class="m">135708371</span> ecr 526053025<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">$&gt; 
</span></span></code></pre></td></tr></table>
</div>
</div><p>由于不再直接从网络接口捕获数据包，所以不需要sudo来读取文件。<br>
您还可以使用我们讨论过的任何过滤器来过滤文件中的内容，就像处理实时数据一样。例如，执行以下命令检查源IP地址<code>54.204.39.132</code>的捕获文件中的数据包:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$&gt; tcpdump -nn -r webserver.pcap src 54.204.39.132
</span></span><span class="line"><span class="cl">reading from file webserver.pcap, link-type LINUX_SLL <span class="o">(</span>Linux cooked<span class="o">)</span>
</span></span><span class="line"><span class="cl">13:36:57.718932 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>S.<span class="o">]</span>, seq 1999298316, ack 3709732620, win 28960, options <span class="o">[</span>mss 1460,sackOK,TS val <span class="m">526052949</span> ecr 135708029,nop,wscale 9<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.756979 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>.<span class="o">]</span>, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">526052959</span> ecr 135708068<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">13:36:57.760122 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>P.<span class="o">]</span>, seq 1:643, ack 113, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">526052959</span> ecr 135708068<span class="o">]</span>, length 642: HTTP: HTTP/1.1 <span class="m">302</span> Found
</span></span><span class="line"><span class="cl">13:36:58.022089 IP 54.204.39.132.80 &gt; 192.168.122.98.39378: Flags <span class="o">[</span>F.<span class="o">]</span>, seq 643, ack 114, win 57, options <span class="o">[</span>nop,nop,TS val <span class="m">526053025</span> ecr 135708327<span class="o">]</span>, length <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>next</code> ?
<code>tcpdump</code>的这些基本特性将帮助您开始使用这个功能强大的通用工具。要了解更多信息，请访问<code>tcpdump</code>网站和<code>man</code>页面。<br>
<code>tcpdump</code>命令行接口为捕获和分析网络流量提供了很大的灵活性。如果您需要图形化工具来理解更复杂的流，请查看<code>Wireshark</code>。<br>
<code>Wireshark</code>的一个优点是它可以读取<code>tcpdump</code>捕获的<code>.pcap</code>文件。您可以使用<code>tcpdump</code>在没有<code>GUI</code>的远程机器中捕获数据包，并使用<code>Wireshark</code>分析结果文件，但这是另一个主题。</p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2022-06-22</span>
            </div>
            <div class="post-info-license"><span><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a></span></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"><span><a class="link-to-mardown" href=/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/index.md target="_blank" rel="noopener noreferrer">阅读原始文档</a>
                    </span></div>
            <div class="post-info-share">
                <span><a href="#" title="分享到 Evernote" data-sharer="evernote" data-url="https://blog.0x5c0f.cc/2019/%E4%BB%8B%E7%BB%8D%E5%9C%A8linux%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%B8%AD%E4%BD%BF%E7%94%A8tcpdump/" data-title="介绍在Linux命令行中使用tcpdump"><i class="fab fa-evernote fa-fw"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><i class="fas fa-tags fa-fw"></i>&nbsp;<a href="/tags/linux/">linux</a>,&nbsp;<a href="/tags/tcpdump/">tcpdump</a></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/2019/systemctl%E4%B9%8Bsystemd%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1/" class="prev" rel="prev" title="Systemctl之systemd自定义系统服务"><i class="fas fa-angle-left fa-fw"></i>Systemctl之systemd自定义系统服务</a>
            <a href="/2020/cobbler%E6%97%A0%E4%BA%BA%E5%80%BC%E5%AE%88%E5%AE%89%E8%A3%85/" class="next" rel="next" title="Cobbler无人值守安装">Cobbler无人值守安装<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div id="comments"><div id="waline" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://waline.js.org/">Waline</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.112.3">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.3.0"><i class="far fa-edit fa-fw"></i> DoIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2022 - 2023</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://tools.0x5c0f.cc" target="_blank" rel="noopener noreferrer">0x5c0f</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a></span><span class="icp-splitter">&nbsp;|&nbsp;</span><br class="icp-br"/>
                    <span class="icp">渝ICP备2020011834号-2</span></div>
            <div class="footer-line"></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons"><a href="#back-to-top" id="back-to-top-button" class="fixed-button" title="回到顶部">
            <i class="fas fa-arrow-up fa-fw"></i>
        </a><a href="#" id="view-comments" class="fixed-button" title="查看评论">
            <i class="fas fa-comment fa-fw"></i>
        </a>
    </div><div class="assets"><link rel="stylesheet" href="/lib/waline/waline.min.css"><link rel="stylesheet" href="/lib/katex/katex.min.css"><link rel="preload" as="style" onload="this.onload=null;this.rel='stylesheet'" href="/lib/katex/copy-tex.min.css">
        <noscript><link rel="stylesheet" href="/lib/katex/copy-tex.min.css"></noscript><script type="text/javascript">window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":10},"comment":{"waline":{"comment":true,"copyright":true,"dark":"body[theme='dark'], body[theme='black']","el":"#waline","emoji":["https://unpkg.com/@waline/emojis@1.1.0/alus"],"lang":"zh-cn","login":"enable","meta":["nick","mail","link"],"pageview":true,"requiredMeta":["mail"],"serverURL":"https://talk.51ac.cc"}},"data":{"desktop-header-typeit":"0x5c0f.cc","mobile-header-typeit":"0x5c0f.cc"},"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"distance":100,"findAllMatches":false,"fuseIndexURL":"/index.json","highlightTag":"em","ignoreFieldNorm":false,"ignoreLocation":true,"isCaseSensitive":false,"location":0,"maxResultLength":10,"minMatchCharLength":2,"noResultsFound":"没有找到结果","snippetLength":50,"threshold":0.3,"type":"fuse","useExtendedSearch":true},"sharerjs":true,"table":{"sort":true},"typeit":{"cursorChar":"_","cursorSpeed":1000,"data":{"desktop-header-typeit":["desktop-header-typeit"],"mobile-header-typeit":["mobile-header-typeit"]},"duration":9000,"speed":100}};</script><script type="text/javascript" src="/lib/waline/waline.js" defer></script><script type="text/javascript" src="/js/waline.min.js" defer></script><script type="text/javascript" src="/lib/tablesort/tablesort.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/typeit.min.js"></script><script type="text/javascript" src="/lib/katex/katex.min.js" defer></script><script type="text/javascript" src="/lib/katex/auto-render.min.js" defer></script><script type="text/javascript" src="/lib/katex/copy-tex.min.js" defer></script><script type="text/javascript" src="/lib/katex/mhchem.min.js" defer></script><script type="text/javascript" src="/js/katex.min.js" defer></script><script type="text/javascript" src="/js/theme.min.js" defer></script><script async defer data-website-id="27ecb7ce-6f65-4ad4-880c-cfdb26623383" src="https://app.51ac.cc/umami.js"   data-domains="blog.0x5c0f.cc" ></script></div>
</body>

</html>